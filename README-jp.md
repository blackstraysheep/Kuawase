# Kuawase 取扱説明書（v0.10.0）

## 1. 概要・初めてご利用の方へ

### Kuawase とは？
**Kuawase**（句合わせ）は、俳句・短歌などの短詩形文芸の競技大会「句合わせ」の進行を支援するプレゼンテーション用アプリケーションです。

### どんなことができるの？
- 2つのチーム（紅組・白組）による句の対戦を、観客にわかりやすく表示
- 各試合の句を画面全体に大きく表示する「披講（ひこう）」機能
- 進行に合わせたBGM再生とタイマー機能
- Excel や Google スプレッドシートから大会データを簡単読み込み

### 画面構成の基本
アプリは**2つのウィンドウ**で構成されています：
1. **管理用ウィンドウ**：運営者が操作する画面（PC の通常画面）
2. **投影用ウィンドウ**：観客向けの表示画面（プロジェクター等で投影）

### v0.10.0 の主な更新点
- **ビルドシステムの強化**と依存関係管理の改善
- **sanitize-html依存関係の問題解決**によるセキュリティ向上
- **electron-builderの設定更新**による安定したパッケージング
- **安定性の向上**とパフォーマンス最適化
- Google スプレッドシートのリンク読み込みと句データリセット機能の継続サポート



## 2. 動作環境
- OS: Windows 10 以降（Windows 11 推奨）  
- ネット接続: 自動更新、および Google スプレッドシート読み込み時に使用  
- ディスク容量: インストールに約200MB  
- メモリ: 最適なパフォーマンスには4GB RAM推奨



## 3. インストール／アップデート
1. 最新のインストーラ（`.exe`）をダウンロードして実行します。  
2. **v0.5 系以降**をご利用の場合は**自動更新**で v0.10.0 に更新されます（更新後に再起動）。  
3. **v0.5.0 未満**からの更新は、旧版をアンインストール後、新しいインストーラを実行してください。

### 初回起動時のセットアップ
1. アプリを起動すると、**管理用ウィンドウ**と**投影用ウィンドウ**の2つが表示されます
2. プロジェクターまたは外部モニターに接続している場合は、**投影用ウィンドウ**をそちらの画面に移動してください
3. **管理用ウィンドウ**は操作用なので、PC の画面で操作します

> **💡 プロジェクター接続のコツ**  
> Windows で外部モニターを使う場合は、`Windows キー + P キー` で「拡張」モードを選ぶと、PC画面とプロジェクター画面を別々に使えて便利です。



## 4. 画面構成

### 4.1 管理用ウィンドウ
管理用ウィンドウは左側に**投影画面のプレビュー**、右側に**操作パネル**が配置されています。

#### 基本操作パネル
- **対戦切り替え（ステージボタン）**  
  - 大会TOP／対戦TOP／先鋒戦／次鋒戦／中堅戦／副将戦／大将戦  
  - ボタンをクリックすると投影画面が即座に切り替わります
- **披講パネル**  
  - **紅 披講**／**白 披講**の2つのボタン  
  - 先鋒戦～大将戦でのみ表示される  
  - ボタンを押すと該当チームの句を投影画面に全画面表示  
  - 同時に披講用BGMを自動再生（設定されている場合）

#### BGM・音響制御
- **BGM再生パネル**
  - **入場**：入場用BGMを再生  
  - **退場**：退場用BGMを再生  
  - **待機**：待機用BGMを再生  
  - **停止**：現在再生中のBGMを停止  
  - **待機ループ**：チェックすると待機BGMを繰り返し再生

#### タイマー機能
- **上下 2 系統のカウントダウンタイマー**  
  - **上段タイマー**：分・秒で設定可能、**保存／開始／一時停止／リセット**を個別に操作  
  - **下段タイマー**：秒のみで設定可能、**保存／開始／一時停止／リセット**を個別に操作  
  - **上段タイマー**は**残り 1:00**で「1 分前」、**0:00**で「そこまで」を表示（管理画面のみ）  
  - タイマーが 0 になると**BGM を自動再生**（タイマー用に設定がある場合）

#### 試合・データ管理
- **試合指定パネル**  
  - 紅チーム／白チーム／兼題（テーマ）／対戦名 を指定して保存  
  - **対戦名**には HTML タグ（例：`<br>`）が使用可能  
- **句データ管理（Excel / Google Sheets）**  
  - **Excel ファイル選択** → 読み込み  
  - **Google スプレッドシートの読み込み** → リンクを貼り付けて読み込み  
  - **句データリセット**：句データ（大会名・兼題・句一覧）のみを初期化（BGM設定・ファイルは維持）  
- **BGM ファイル管理**  
  - ファイルのアップロード、削除（個別／一括）  
  - シーン別割り当て（披講／入場／退場／待機／タイマー終了 など）  
  - **BGM 設定保存**で設定を反映  
- **表示設定／その他**  
  - テーマカラー変更、言語切替（日本語／English）、全データ初期化 など

### 4.2 投影用ウィンドウ
- **初期表示**：大会トップページ  
  - 大会名のみを表示  
- **対戦トップ（対戦TOPページ）**：  
  - 上部：大会名  
  - 中央上：対戦名（例：「Ａブロック 第１試合」）  
  - 中央：兼題名  
  - 下部：「対戦TOP」（English: "Match TOP"）  
  - 左右：紅・白チーム名  
  - 左右端：紅・白の句を小さく表示  
- **先鋒戦～大将戦**：  
  - 基本レイアウトは対戦トップと同様  
  - 中央下部に各戦の名前（「先鋒戦」「次鋒戦」など）を表示  
  - 披講ボタンを押すと、該当チームの句が画面全体に大きく表示される  
- **言語切替**：日本語／English で各ラベルが自動切替  
- 管理側でのステージ操作に連動して自動更新



## 5. データ準備と読み込み

### 5.1 Excel テンプレートの要点
- B1：大会名  
- D1：チーム数  
- F1：兼題数  
- H1 以降（2 列刻み）：兼題名  
- B3 以降（縦）：チーム名  
- 各チーム×各兼題の**句データ**を所定セルへ記入

> 取り込み後、アプリのユーザーデータ領域に内部形式で保持されます。

### 5.2 Excel からの読み込み
1. 管理画面 → **句データ管理** → **Excel ファイル選択** で `.xlsx` を指定  
2. 読み込み成功時は画面上部に反映（大会名や読み込み元の表示で確認）  
3. 「読み込み元：」の右側に読み込んだファイル名が表示されます

### 5.3 Google スプレッドシートからの読み込み（v0.8.0以降）
1. **共有設定の変更**：  
   - スプレッドシートの**共有ボタン**（右上）をクリック  
   - 「**一般的なアクセス**」を「**リンクを知っている全員**」に変更  
   - 権限が「**閲覧者**」になっていることを確認  
2. **読み込み手順**：  
   - 管理画面で「**Googleスプレッドシート読み込み**」ボタンをクリック  
   - モーダルが開くので、「**リンクをコピー**」したURLを入力欄に貼り付け  
   - 「**読み込み**」ボタンをクリック  
3. **注意事項**：  
   - 内部的には `.xlsx` と同等に変換・解析されます  
   - 不正なリンクやアクセス権限がない場合はエラーメッセージで通知  
   - 読み込み成功時は画面上部に反映（大会名で確認可能）
   - 「読み込み元：」の右側に読み込んだURLが表示されます



## 6. 基本的な操作手順（初回利用時）

### Step 1: データの準備・読み込み
1. Excel テンプレートに大会データを入力、または Google スプレッドシートを準備
2. 管理画面の「句データ管理」から Excel ファイルまたは Google スプレッドシートを読み込み
3. 読み込み成功を画面上部の大会名表示で確認

### Step 2: 対戦の設定
1. 管理画面下部の「対戦指定パネル」で以下を設定：
   - 紅チーム・白チーム（読み込んだデータから選択）
   - 兼題（テーマ）
   - 対戦名（例：「Aブロック<br>第1試合」）
2. 「保存」ボタンをクリックして設定を反映

### Step 3: 投影画面の操作
1. 「対戦切り替え」ボタンで投影画面を切り替え：
   - **大会TOP**：大会名のみ表示
   - **対戦TOP**：対戦情報と句の概要表示  
   - **先鋒戦～大将戦**：各試合の詳細表示
2. 先鋒戦～大将戦の画面では「紅 披講」「白 披講」ボタンが使用可能
3. 披講ボタンで該当チームの句を全画面表示

### Step 4: BGM・タイマーの活用（オプション）
1. 必要に応じてBGMファイルをアップロードし、シーン別に設定
2. タイマーを使用して進行時間を管理
3. 「BGM設定保存」で設定を反映後、各種BGMボタンで音響演出



## 7. 表示操作（ステージ切替と披講）
- **ステージボタン**で投影側のページ（大会TOP／対戦TOP／各試合）を切り替え  
- **披講機能**：  
  - **紅 披講**／**白 披講**ボタンは先鋒戦～大将戦でのみ表示  
  - ボタンを押すと該当チームの句を投影画面に全画面表示  
  - 披講時に自動的にBGMを再生（設定されている場合）  
- 管理画面をリロードした場合、投影側は**大会トップページ**に戻る仕様



## 8. BGM の管理

### 8.1 アップロード／削除
- **BGM ファイル管理**から音声ファイルを選択してアップロード  
- **ユーザーBGMファイル一覧**に表示され、**削除（個別）**および**一括削除**が可能  
- 削除前に**確認モーダル**が表示され、誤削除を防止
- 削除はアプリの作業用コピーに対して行われ、**元ファイルは変更されません**
- 一般的な音声形式（MP3、WAV、M4A等）をサポート

### 8.2 シーン別設定と再生
- **披講／入場／退場／待機／タイマー終了（各タイマーごと）**に曲を割り当て  
- **BGM再生ボタン**：  
  - **入場**：入場用BGMを再生  
  - **退場**：退場用BGMを再生  
  - **待機**：待機用BGMを再生  
  - **停止**：現在再生中のBGMを停止  
- **待機ループ** ON で待機 BGM を繰り返し再生（チェックボックスは再生中でも即時反映）  
- **BGM 設定保存**で設定を反映  
- 1度に再生される BGM は**常に 1 曲のみ**（新規再生で上書き、披講も含みます）



## 9. タイマー
- **上下 2 系統**のカウントダウンタイマー  
- **上段タイマー**：分・秒で設定可能、**保存／開始／一時停止／リセット**を個別に操作  
- **下段タイマー**：秒のみで設定可能、**保存／開始／一時停止／リセット**を個別に操作  
- **上段タイマーの特別表示**：  
  - **残り1:00**で管理画面に「1分前」を表示  
  - **0:00到達**で管理画面に「そこまで」を表示  
- **BGM自動再生**：各タイマーが0到達時に設定されたBGMを自動再生  
- **タイマーパネルの折りたたみ**：▼ボタンでパネルを折りたたみ可能（タイマーは動作継続）



## 10. 言語とテーマ
- **言語切り替え**：  
  - 管理画面の「表示設定・その他」パネル内にある「日本語」「English」ボタンをクリック
  - UI ラベルがロケールに基づき自動切替されます
  - 例：大会TOP ↔ Compe TOP、対戦TOP ↔ Match TOP、  
    先鋒戦 ↔ Open. Bout、次鋒戦 ↔ Sec. Bout、  
    中堅戦 ↔ Mid. Bout、副将戦 ↔ Penult. Bout、大将戦 ↔ Fin. Bout、  
    披講 ↔ Recitation（Red / White を含む）
- **テーマカラー変更**：  
  - 管理画面の「表示設定・その他」パネル内の「テーマカラー」プルダウンメニューから選択
  - 選択すると投影画面の配色が即座に反映されます
- **対戦デザイン（CSS）テーマ**：
  - 投影画面表示テーマを複数から選択可能：標準、ダーク、和紙、ネオ
  - 「カスタムCSS追加」ボタンでオリジナルCSSファイルを追加可能
  - アップロードしたCSSファイルはユーザーCSS一覧に表示され、個別削除可能
- **管理画面ダークモード**：
  - 「表示設定・その他」内のチェックボックスで管理画面のダークモード切り替え
  - 投影画面の表示には影響しません



## 11. 表示・操作設定
- **表示サイズ調整**：  
  - `Ctrl` + `-`（ズームアウト/縮小）／ `Ctrl` + `Shift` + `+`（ズームイン/拡大）／ `Ctrl` + `0`（100%にリセット）  
  - 管理用ウィンドウ・投影用ウィンドウのそれぞれでキーボードショートカットを使用してサイズ調整可能
  - 各ウィンドウをアクティブ（クリック）にしてからショートカットキーを押してください
  - 画面解像度やプロジェクター設定に合わせた表示サイズ調整に便利
  - ズーム設定はセッション間で保持されます
- **パネルの折りたたみ**：  
  - 各パネル（タイマー、BGMファイル管理、句データ管理など）右上の ▼ ボタンでパネルを折りたたみ可能
  - 折りたたんでも機能は動作継続（例：タイマーは動作継続）
- **ユーザーインターフェースのフィードバック**：
  - **トーストメッセージ**が画面下部に表示され、操作成功（ファイル読み込み、設定保存等）を通知
  - **確認モーダル**により誤削除やデータ損失を防止
  - **エラーメッセージ**で操作失敗時に具体的な対処法を提供



## 12. 保存・リセットの種類と挙動
- **試合指定の保存**：管理画面の対戦指定パネルで保存すると、投影表示や内部設定に即座に反映  
- **句データリセット**：**句データ（大会名・兼題・句一覧）のみ初期化**（v0.10.0で強化）  
  - BGM設定やアップロード済みBGMファイルは**維持される**  
  - 句データ管理パネル内の専用ボタンで実行  
- **全データリセット**：読み込んだExcelデータ、試合指定、**BGM設定**をすべて初期化  
  - アップロード済みBGMファイルも削除される  
- **BGMファイルの個別削除**：BGM管理の各行から**個別削除**可能（元ファイルは保持）  
- **BGMファイルの一括削除**：BGM管理パネルから全BGMファイルを一括削除可能



## 13. よくある質問（FAQ）

### Q. アプリを起動したが何も読み込まれていない
**A.** 初回起動時は何もデータが入っていない状態です。以下の手順で進めてください：
1. Excel テンプレートまたは Google スプレッドシートを準備
2. 管理画面の「句データ管理」からファイルを読み込み
3. 「対戦指定パネル」で試合設定を行い「保存」をクリック

### Q. プロジェクター画面に正しく表示されない
**A.** 以下を確認してください：
- Windows キー + P で「拡張」モードを選択
- 投影用ウィンドウをプロジェクター画面にドラッグして移動
- 投影用ウィンドウを最大化または全画面表示

### Q. 披講ボタンが表示されない
**A.** 披講ボタンは先鋒戦～大将戦でのみ表示される仕様です。対戦TOPや大会TOPでは表示されません。

### Q. BGMが鳴らない
**A.** 以下を確認してください：
1. BGMファイルがアップロードされているか
2. シーン別設定で適切な曲が選択されているか  
3. 「BGM設定保存」ボタンを押したか
4. システムの音量設定

### Q. タイマー表示が邪魔になる
**A.** タイマーパネル右上の ▼ ボタンでパネルを折りたたみできます（動作は継続）

### Q. Excel/Google Sheetsが読み込めない
**A.** 以下を確認してください：
- Google Sheets の場合：共有設定が「リンクを知っている全員」「閲覧者」になっているか
- Excel の場合：ファイル形式が `.xlsx` になっているか
- ファイルが破損していないか
- 一度アプリを再起動してから再試行



## 14. トラブルシューティング
- **Excel／Google Sheetsが読み込めない**  
  - 共有設定（リンク共有／閲覧者）とファイル形式を再確認  
  - いったんアプリ再起動のうえ再試行  
- **ビルド・インストール関連問題（v0.10.0の改善）**
  - sanitize-htmlパッケージの依存関係問題を解決  
  - electron-builderの設定を強化し、より安定したパッケージングを実現  
  - インストール時に問題が発生した場合は、最新版インストーラーをダウンロード  
- **投影側が更新されない**  
  - 管理側でステージを再切替してみる  
- **披講ボタンが表示されない**  
  - 披講ボタンは先鋒戦～大将戦でのみ表示される仕様  
  - 対戦TOPや大会TOPでは表示されない  
- **BGMが鳴らない**  
  - 「BGM設定保存」を実行したか確認  
  - システムの音量設定や対応ファイル形式を確認  
- **タイマー表示が邪魔な場合**  
  - ▼ボタンでタイマーパネルを折りたたみ（動作は継続）  
- **句が正しく表示されない**  
  - Excelテンプレートの形式が正しいか確認  
  - 試合指定パネルで紅・白チーム、兼題が正しく設定されているか確認

## 15. レイアウト命名リファクタ (v0.8.x)
v0.8.x で表示レイアウトの CSS / HTML 命名を直感的なクラスベースへ移行しました。旧 ID は今後削除予定です。

| 旧 ID / クラス | 新クラス / ID | 用途 | 備考 |
|----------------|---------------|------|------|
| `#wrapper` | `.battle-layout` | 3カラム全体ラッパ | 旧は `display:contents` 化 |
| `#left2` | `.poem-panel.poem-panel--red` | 紅 句パネル | 暫定: 旧ID残存 |
| `#right2` | `.poem-panel.poem-panel--white` | 白 句パネル | 暫定: 旧ID残存 |
| `#main` | `.match-panel` | 中央試合情報 |  |
| `#left3` | `.team-slot.team-slot--red` | 紅 チーム名枠 | |
| `#right3` | `.team-slot.team-slot--white` | 白 チーム名枠 | |
| `.team` | `.team-name` | チーム名縦書き | |
| `.kunakami` | `.haiku-text` | 句表示テキスト | 縦書き保持 |
| `.left` / `.ku` | `.haiku-container` | 句コンテナ | 統一 |
| `#redHaiku` / `#whiteHaiku` | (同) | 句要素ID | 維持 |
| `#gameid` | (同) | 試合グループ表示 | 維持 |
| `#kendai` | (同) | 兼題表示 | 維持 |
| `#matchid` | (同) | ステージラベル | 維持 |
| `#redTeam` / `#whiteTeam` | `#redTeam` / `#whiteTeam` | チーム名 | 維持 |

### テーマCSS互換
`battle.theme.*.css` は新クラス (`.poem-panel`, `.match-panel`, `.team-slot`) へスタイルを複製済みです。段階的に旧 ID セレクタを削除可能です。

### JS 変更点
`battle.js` 内の `closest('#left2, #right2')` は `.poem-panel` 参照へ更新。その他 ID 参照は変更なし。

### 移行ガイド
1. 外部プラグイン等で旧 ID を参照している場合は新クラスへ置換してください。
2. カスタム CSS を上書きしている場合はセレクタ調整が必要です。
3. 旧 ID を利用した独自スクリプトが無ければ次期バージョンで旧 ID 削除予定です。

---
